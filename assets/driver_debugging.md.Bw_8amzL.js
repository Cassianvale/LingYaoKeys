import{_ as i,c as a,o as n,ag as l}from"./chunks/framework.C48t5LJr.js";const g=JSON.parse('{"title":"调试指南","description":"","frontmatter":{},"headers":[],"relativePath":"driver/debugging.md","filePath":"driver/debugging.md","lastUpdated":1742378511000}'),p={name:"driver/debugging.md"};function e(t,s,h,k,d,r){return n(),a("div",null,s[0]||(s[0]=[l(`<h1 id="调试指南" tabindex="-1">调试指南 <a class="header-anchor" href="#调试指南" aria-label="Permalink to &quot;调试指南&quot;">​</a></h1><h2 id="调试工具" tabindex="-1">调试工具 <a class="header-anchor" href="#调试工具" aria-label="Permalink to &quot;调试工具&quot;">​</a></h2><h3 id="windbg" tabindex="-1">WinDbg <a class="header-anchor" href="#windbg" aria-label="Permalink to &quot;WinDbg&quot;">​</a></h3><ol><li><p>安装步骤：</p><div class="language-powershell vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">powershell</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 使用winget安装WinDbg</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">winget install Microsoft.WinDbg</span></span></code></pre></div></li><li><p>配置系统生成完整转储：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. 右键&quot;此电脑&quot; -&gt; 属性</span></span>
<span class="line"><span>2. 高级系统设置 -&gt; 高级 -&gt; 启动和故障恢复 -&gt; 设置</span></span>
<span class="line"><span>3. 在&quot;写入调试信息&quot;下选择&quot;完整内存转储&quot;</span></span>
<span class="line"><span>4. 确保&quot;自动重新启动&quot;已勾选</span></span></code></pre></div></li><li><p>使用WinDbg分析：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. 打开 WinDbg</span></span>
<span class="line"><span>2. File -&gt; Open Crash Dump</span></span>
<span class="line"><span>3. 选择 C:\\Windows\\MEMORY.DMP 或 Minidump 文件</span></span></code></pre></div></li><li><p>常用命令：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>!analyze -v    # 详细分析崩溃原因</span></span>
<span class="line"><span>.bugcheck      # 显示蓝屏代码</span></span>
<span class="line"><span>kb             # 显示调用栈</span></span>
<span class="line"><span>lmvm lykeys    # 显示驱动信息</span></span></code></pre></div></li></ol><h3 id="bluescreenview" tabindex="-1">BlueScreenView <a class="header-anchor" href="#bluescreenview" aria-label="Permalink to &quot;BlueScreenView&quot;">​</a></h3><ol><li><p>使用步骤：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>1. 下载并安装 BlueScreenView</span></span>
<span class="line"><span>2. 运行后自动显示所有蓝屏记录</span></span>
<span class="line"><span>3. 查看：</span></span>
<span class="line"><span>   - 蓝屏代码</span></span>
<span class="line"><span>   - 发生时间</span></span>
<span class="line"><span>   - 导致崩溃的驱动</span></span>
<span class="line"><span>   - 调用栈信息</span></span></code></pre></div></li><li><p>分析信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>需要提供的信息</span></span>
<span class="line"><span>{</span></span>
<span class="line"><span>    1. 基本信息:</span></span>
<span class="line"><span>    - 蓝屏代码 (例如: 0x0000007E)</span></span>
<span class="line"><span>    - 发生时间</span></span>
<span class="line"><span>    - 系统版本</span></span>
<span class="line"><span>    2. 详细信息:</span></span>
<span class="line"><span>    - 导致崩溃的驱动名称</span></span>
<span class="line"><span>    - 崩溃时的调用栈</span></span>
<span class="line"><span>    - 相关的内存地址</span></span>
<span class="line"><span>    3. 环境信息:</span></span>
<span class="line"><span>    - 系统配置</span></span>
<span class="line"><span>    - 已安装的驱动</span></span>
<span class="line"><span>    - 硬件信息</span></span>
<span class="line"><span>}</span></span></code></pre></div></li></ol><h2 id="驱动验证" tabindex="-1">驱动验证 <a class="header-anchor" href="#驱动验证" aria-label="Permalink to &quot;驱动验证&quot;">​</a></h2><h3 id="验证工具" tabindex="-1">验证工具 <a class="header-anchor" href="#验证工具" aria-label="Permalink to &quot;验证工具&quot;">​</a></h3><ol><li><p>完整验证（推荐用于开发测试）</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">verifier /flags </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0xFF</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /driver lykeys.sys</span></span></code></pre></div></li><li><p>基本验证（推荐用于日常测试）</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">verifier /standard /driver lykeys.sys</span></span></code></pre></div></li><li><p>内存验证（针对内存问题）</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">verifier /flags </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x5</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /driver lykeys.sys</span></span></code></pre></div></li><li><p>IRQL验证（针对IRQL问题）</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">verifier /flags </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0x2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /driver lykeys.sys</span></span></code></pre></div></li></ol><h3 id="本地内核调试" tabindex="-1">本地内核调试 <a class="header-anchor" href="#本地内核调试" aria-label="Permalink to &quot;本地内核调试&quot;">​</a></h3><ol><li><p>配置调试：</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bcdedit /debug on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bcdedit /dbgsettings local</span></span></code></pre></div></li><li><p>添加详细日志：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Driver State: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, IRQL: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, state, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KeGetCurrentIrql</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Callback Address: 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%p\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, callback));</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Memory Region: 0x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%p</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, Size: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, address, size));</span></span></code></pre></div></li></ol><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="驱动服务问题" tabindex="-1">驱动服务问题 <a class="header-anchor" href="#驱动服务问题" aria-label="Permalink to &quot;驱动服务问题&quot;">​</a></h3><ol><li><p>手动停止服务：</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sc query lykeys</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sc stop lykeys</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">sc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lykeys</span></span></code></pre></div></li><li><p>快捷命令：</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@echo off </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sc query lykeys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nul </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (echo Service </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">exists</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, stopping... </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sc stop lykeys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nul </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> timeout /t </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> /nobreak </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nul </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sc </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">delete</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> lykeys </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nul </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> echo Service deleted successfully </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exit) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (echo Service does </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">not</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exist </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> exit)</span></span></code></pre></div></li></ol><h3 id="驱动签名问题" tabindex="-1">驱动签名问题 <a class="header-anchor" href="#驱动签名问题" aria-label="Permalink to &quot;驱动签名问题&quot;">​</a></h3><ol><li><p>测试模式设置：</p><div class="language-cmd vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cmd</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"># 禁用强制驱动签名 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 测试模式 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 重启</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bcdedit /</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">set </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nointegritychecks on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bcdedit /</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">set </span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">testsigning on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">shutdown </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span></span></code></pre></div></li><li><p>签名验证：</p><ul><li>检查驱动签名证书</li><li>验证签名时间戳</li><li>确认签名链完整性</li></ul></li></ol><h2 id="调试技巧" tabindex="-1">调试技巧 <a class="header-anchor" href="#调试技巧" aria-label="Permalink to &quot;调试技巧&quot;">​</a></h2><h3 id="日志记录" tabindex="-1">日志记录 <a class="header-anchor" href="#日志记录" aria-label="Permalink to &quot;日志记录&quot;">​</a></h3><ol><li><p>添加详细日志：</p><div class="language-c vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">c</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录关键操作</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Operation: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, operation));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录参数信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Parameters: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, param1, param2));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 记录错误信息</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">KdPrint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">((</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Error: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%d\\n</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, error));</span></span></code></pre></div></li><li><p>日志分析：</p><ul><li>使用日志分析工具</li><li>过滤关键信息</li><li>追踪问题根源</li></ul></li></ol>`,19)]))}const o=i(p,[["render",e]]);export{g as __pageData,o as default};
